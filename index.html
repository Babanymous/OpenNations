<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OpenNations: World Conflict</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .game-card { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .btn-primary { background: linear-gradient(to bottom, #3b82f6, #2563eb); border-top: 1px solid #60a5fa; transition: transform 0.1s; }
        .btn-primary:active { transform: translateY(2px); }
        .btn-danger { background: linear-gradient(to bottom, #ef4444, #dc2626); border-top: 1px solid #f87171; }
        .btn-success { background: linear-gradient(to bottom, #22c55e, #16a34a); border-top: 1px solid #4ade80; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        .toast { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col select-none">

    <div id="toast-container" class="fixed top-16 left-0 right-0 z-[60] flex flex-col items-center gap-2 pointer-events-none"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center">
        <div class="relative w-16 h-16 mb-4">
            <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-xl font-bold tracking-[0.2em] text-blue-400">CONNECTING...</h2>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden fixed inset-0 z-40 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center p-6">
            <div class="text-center mb-10">
                <i data-lucide="globe-2" class="w-20 h-20 text-blue-500 mx-auto mb-4 rounded-full shadow-lg shadow-blue-500/50"></i>
                <h1 class="text-5xl font-black text-white tracking-tighter mb-2">OPEN<span class="text-blue-500">NATIONS</span></h1>
            </div>
            <button id="login-btn" class="btn-primary w-full max-w-sm py-4 rounded-xl font-bold text-lg shadow-2xl flex items-center justify-center gap-3">
                <i data-lucide="log-in"></i> Initialize Regime
            </button>
        </div>
    </div>

    <!-- CREATE NATION SCREEN -->
    <div id="create-screen" class="hidden fixed inset-0 z-40 bg-slate-900 p-6 flex items-center justify-center overflow-y-auto">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl my-auto">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <i data-lucide="flag" class="text-blue-500"></i> Found New Nation
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Nation Name</label>
                    <input type="text" id="new-nation-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" placeholder="Republic of...">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Leader Name</label>
                    <input type="text" id="new-leader-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" placeholder="President...">
                </div>
                
                <!-- NEW: FILE UPLOAD SECTION -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">National Flag (Upload)</label>
                    <div class="mt-2 flex items-center gap-4">
                        <div class="relative w-16 h-12 bg-slate-900 rounded border border-slate-700 overflow-hidden flex-shrink-0">
                            <img id="flag-preview" class="w-full h-full object-cover hidden">
                            <div id="flag-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-600">
                                <i data-lucide="image"></i>
                            </div>
                        </div>
                        <label class="cursor-pointer btn-primary px-4 py-2 rounded text-sm font-bold flex-1 text-center">
                            Select Image
                            <input type="file" id="flag-upload" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">Images are automatically resized to save data.</p>
                </div>

                <button id="create-nation-btn" class="btn-success w-full py-4 rounded-lg font-bold text-white shadow-lg mt-4">Establish Nation</button>
            </div>
        </div>
    </div>

    <!-- MAIN GAME UI -->
    <div id="game-ui" class="hidden flex-1 flex flex-col h-full relative bg-slate-900">
        
        <!-- HEADER -->
        <header class="glass-panel z-20 border-b border-slate-700 shadow-lg">
            <div class="px-3 py-2 flex justify-between items-center bg-slate-900/50">
                <div class="flex items-center gap-2">
                    <img id="nav-flag" src="" class="w-8 h-6 object-cover rounded shadow ring-1 ring-slate-600">
                    <div class="leading-none">
                        <div id="nav-nation-name" class="font-bold text-sm text-white">Loading...</div>
                        <div class="text-[10px] text-emerald-400 font-mono flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> ONLINE
                        </div>
                    </div>
                </div>
                <div class="text-xs font-mono text-slate-400">Day <span id="game-day">1</span></div>
            </div>
            
            <!-- SCROLLABLE RESOURCES -->
            <div class="flex overflow-x-auto py-2 px-2 gap-4 bg-slate-950/50 hide-scrollbar border-t border-slate-800">
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Money</span>
                    <span class="font-bold text-emerald-400">$<span id="res-money">0</span></span>
                </div>
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Food</span>
                    <span class="font-bold text-orange-300"><span id="res-food">0</span></span>
                </div>
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Steel</span>
                    <span class="font-bold text-slate-300"><span id="res-steel">0</span></span>
                </div>
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Alum.</span>
                    <span class="font-bold text-slate-400"><span id="res-aluminum">0</span></span>
                </div>
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Gas</span>
                    <span class="font-bold text-purple-400"><span id="res-gasoline">0</span></span>
                </div>
                <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] text-slate-400 uppercase">Ammo</span>
                    <span class="font-bold text-red-400"><span id="res-munitions">0</span></span>
                </div>
            </div>
        </header>

        <!-- MAIN SCROLL AREA -->
        <main class="flex-1 overflow-y-auto pb-24 relative" id="main-scroll">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="p-4 space-y-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-5 border border-slate-700 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="landmark" size="100"></i></div>
                    <div class="relative z-10">
                        <h2 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-1">State of the Nation</h2>
                        <div class="text-3xl font-black text-white mb-4" id="dash-nation-name">...</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800">
                                <div class="text-xs text-slate-500 uppercase">Leader</div>
                                <div class="font-bold text-white" id="dash-leader">Unknown</div>
                            </div>
                            <div class="bg-slate-950/50 p-3 rounded-lg border border-slate-800">
                                <div class="text-xs text-slate-500 uppercase">Population</div>
                                <div class="font-bold text-white" id="dash-pop">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MILITARY -->
                <div>
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 ml-1">Military Assets</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openRecruitModal('soldiers')" class="game-card p-3 rounded-lg flex items-center justify-between hover:bg-slate-700 transition">
                            <div><div class="text-xs text-slate-400">Soldiers</div><div class="font-bold text-lg text-white" id="mil-soldiers">0</div></div>
                            <i data-lucide="users" class="text-emerald-500"></i>
                        </button>
                        <button onclick="openRecruitModal('tanks')" class="game-card p-3 rounded-lg flex items-center justify-between hover:bg-slate-700 transition">
                            <div><div class="text-xs text-slate-400">Tanks</div><div class="font-bold text-lg text-white" id="mil-tanks">0</div></div>
                            <i data-lucide="shield" class="text-blue-500"></i>
                        </button>
                        <button onclick="openRecruitModal('aircraft')" class="game-card p-3 rounded-lg flex items-center justify-between hover:bg-slate-700 transition">
                            <div><div class="text-xs text-slate-400">Aircraft</div><div class="font-bold text-lg text-white" id="mil-aircraft">0</div></div>
                            <i data-lucide="plane" class="text-purple-500"></i>
                        </button>
                        <button onclick="openRecruitModal('ships')" class="game-card p-3 rounded-lg flex items-center justify-between hover:bg-slate-700 transition">
                            <div><div class="text-xs text-slate-400">Ships</div><div class="font-bold text-lg text-white" id="mil-ships">0</div></div>
                            <i data-lucide="anchor" class="text-orange-500"></i>
                        </button>
                    </div>
                </div>

                <!-- CITIES -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-slate-500 uppercase ml-1">Territories</h3>
                        <button id="found-city-btn" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-full font-bold shadow-lg shadow-blue-900/50 transition flex items-center gap-1">
                            <i data-lucide="plus" size="10"></i> FOUND CITY ($50k)
                        </button>
                    </div>
                    <div id="cities-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- WAR ROOM -->
            <div id="view-war" class="hidden p-4 space-y-4">
                <div class="bg-red-900/20 border border-red-500/30 p-4 rounded-xl mb-6">
                    <h2 class="text-red-500 font-bold text-lg flex items-center gap-2">
                        <i data-lucide="crosshair"></i> Global War Room
                    </h2>
                    <p class="text-xs text-red-200/60 mt-1">Select a target. Ensure your military score exceeds theirs to guarantee victory and loot resources.</p>
                </div>
                <div id="enemy-list" class="space-y-3">
                    <div class="flex justify-center p-8"><i class="animate-spin text-slate-600" data-lucide="radar"></i></div>
                </div>
            </div>
            
            <!-- SETTINGS -->
            <div id="view-settings" class="hidden p-4">
                <button id="logout-btn" class="w-full btn-danger p-4 rounded-lg font-bold">Log Out</button>
            </div>

        </main>

        <!-- NAV BAR -->
        <nav class="absolute bottom-0 w-full glass-panel border-t border-slate-700 pb-safe pt-2 px-2 flex justify-around items-center z-30">
            <button onclick="switchView('dashboard')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 text-blue-500">
                <i data-lucide="layout-dashboard" class="group-hover:scale-110 transition"></i><span class="text-[9px] font-bold uppercase tracking-widest">Nation</span>
            </button>
            <button onclick="switchView('war')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 text-slate-500">
                <i data-lucide="sword" class="group-hover:scale-110 transition"></i><span class="text-[9px] font-bold uppercase tracking-widest">War</span>
            </button>
             <button onclick="switchView('settings')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 text-slate-500">
                <i data-lucide="settings" class="group-hover:scale-110 transition"></i><span class="text-[9px] font-bold uppercase tracking-widest">Menu</span>
            </button>
        </nav>

        <!-- RECRUIT MODAL -->
        <div id="recruit-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-end sm:items-center justify-center sm:p-4">
            <div class="bg-slate-800 w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 border-t sm:border border-slate-700 shadow-2xl animate-slide-up">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="users"></i> Recruit <span id="recruit-type-name" class="capitalize">Units</span></h3>
                    <button onclick="document.getElementById('recruit-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
                </div>
                <div class="bg-slate-900 p-4 rounded-lg mb-6 text-sm space-y-2">
                    <div class="flex justify-between text-slate-400"><span>Cost per unit:</span></div>
                    <div id="recruit-cost-display" class="grid grid-cols-2 gap-2 font-mono text-white font-bold"></div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="recruit-amount" value="10" min="1" class="bg-slate-900 border border-slate-600 text-center text-white font-bold rounded-lg w-20 outline-none focus:border-blue-500">
                    <button id="confirm-recruit-btn" class="flex-1 btn-primary py-3 rounded-lg font-bold">PURCHASE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, getDocs, increment, serverTimestamp, runTransaction, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHqPKczjs451HSI9NnRDKM7hXtWOwu0f4",
            authDomain: "opennations-b73bd.firebaseapp.com",
            projectId: "opennations-b73bd",
            storageBucket: "opennations-b73bd.firebasestorage.app",
            messagingSenderId: "45297560412",
            appId: "1:45297560412:web:1ebee9783a042322402f99",
            measurementId: "G-3R641VW9RM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const UNIT_STATS = {
            soldiers: { cost: { money: 100, food: 5, munitions: 1 } },
            tanks:    { cost: { money: 500, steel: 10, munitions: 5 } },
            aircraft: { cost: { money: 2000, aluminum: 15, gasoline: 10, munitions: 10 } },
            ships:    { cost: { money: 5000, steel: 50, gasoline: 20, munitions: 20 } }
        };

        const BUILDING_STATS = {
            farm:           { name: "Farm",             cost: 1000 },
            steelMill:      { name: "Steel Mill",       cost: 2500 },
            bauxiteMine:    { name: "Bauxite Mine",     cost: 3000 },
            refinery:       { name: "Oil Refinery",     cost: 3500 },
            ammoFactory:    { name: "Ammo Factory",     cost: 5000 },
            house:          { name: "Housing Project",  cost: 500 }
        };

        let currentUser = null;
        let currentNation = null;
        let selectedRecruitType = null;
        let uploadedFlagBase64 = null; // Store image string

        // --- HELPERS ---
        const formatNum = (n) => n >= 1000 ? (n/1000).toFixed(1) + 'k' : n;
        const show = (id) => document.getElementById(id).classList.remove('hidden');
        const hide = (id) => document.getElementById(id).classList.add('hidden');
        const toast = (msg, type='info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast pointer-events-auto px-6 py-3 rounded-xl shadow-2xl text-white text-xs font-bold uppercase tracking-widest backdrop-blur-md border ${
                type === 'error' ? 'bg-red-500/80 border-red-400' : 
                type === 'success' ? 'bg-emerald-500/80 border-emerald-400' : 
                'bg-blue-500/80 border-blue-400'}`;
            el.innerHTML = msg;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(), 300); }, 3000);
        };

        // --- IMAGE COMPRESSION LOGIC (MAGIC SAUCE) ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // MAX SIZE: 200x200px (Very small, perfect for free db)
                        const MAX = 200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX) { height *= MAX / width; width = MAX; }
                        } else {
                            if (height > MAX) { width *= MAX / height; height = MAX; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        // Convert to JPEG at 70% quality
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        // Handle File Input
        document.getElementById('flag-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadedFlagBase64 = await compressImage(file);
                // Show preview
                document.getElementById('flag-preview').src = uploadedFlagBase64;
                document.getElementById('flag-preview').classList.remove('hidden');
                document.getElementById('flag-placeholder').classList.add('hidden');
            }
        });

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            hide('loading-screen');
            if (user) {
                currentUser = user;
                hide('auth-screen');
                await loadGame();
            } else {
                show('auth-screen');
            }
        });
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => toast(e.message, 'error'));
        document.getElementById('logout-btn').onclick = () => { signOut(auth); location.reload(); };

        // --- LOAD GAME ---
        async function loadGame() {
            show('loading-screen');
            const nationRef = doc(db, "nations", currentUser.uid);
            const snap = await getDoc(nationRef);

            if (snap.exists()) {
                currentNation = snap.data();
                await calculateOffline(nationRef, currentNation);
                initUI();
            } else {
                hide('loading-screen');
                show('create-screen');
            }
        }

        // --- CREATE NATION (UPDATED) ---
        document.getElementById('create-nation-btn').onclick = async () => {
            const name = document.getElementById('new-nation-name').value;
            const leader = document.getElementById('new-leader-name').value;
            // Use uploaded flag OR default if none selected
            const flag = uploadedFlagBase64 || 'https://lucide.dev/icon.svg';

            if(!name || !leader) return toast("Name & Leader required", 'error');

            show('loading-screen');
            try {
                await setDoc(doc(db, "nations", currentUser.uid), {
                    name, leader, flag, ownerId: currentUser.uid,
                    resources: { money: 50000, food: 1000, steel: 100, aluminum: 0, gasoline: 0, munitions: 100 },
                    military: { soldiers: 50, tanks: 0, aircraft: 0, ships: 0 },
                    stats: { population: 1000, score: 0 },
                    lastCollection: serverTimestamp()
                });
                await addDoc(collection(db, "cities"), {
                    nationId: currentUser.uid, name: "Capital",
                    buildings: { house: 10, farm: 2, steelMill: 1, bauxiteMine: 0, refinery: 0, ammoFactory: 1 }
                });
                location.reload();
            } catch(e) { hide('loading-screen'); toast(e.message, 'error'); }
        };

        // --- OFFLINE LOGIC ---
        async function calculateOffline(ref, data) {
            const now = new Date();
            const last = data.lastCollection?.toDate() || now;
            const mins = Math.min(Math.floor((now - last) / 60000), 1440); // Cap 24h

            if (mins > 1) {
                const citiesQ = query(collection(db, "cities"), where("nationId", "==", currentUser.uid));
                const snaps = await getDocs(citiesQ);
                let prod = { money: 0, food: 0, steel: 0, aluminum: 0, gasoline: 0, munitions: 0 };
                
                snaps.forEach(d => {
                    const b = d.data().buildings;
                    if(b.house) prod.money += b.house * 50;
                    if(b.farm) prod.food += b.farm * 10;
                    if(b.steelMill) prod.steel += b.steelMill * 5;
                    if(b.bauxiteMine) prod.aluminum += b.bauxiteMine * 4;
                    if(b.refinery) prod.gasoline += b.refinery * 4;
                    if(b.ammoFactory) prod.munitions += b.ammoFactory * 5;
                });

                const updates = { lastCollection: serverTimestamp() };
                for(let k in prod) {
                    updates[`resources.${k}`] = increment(prod[k] * mins);
                    currentNation.resources[k] += (prod[k] * mins);
                }
                await updateDoc(ref, updates);
                toast(`Offline for ${mins}m: Resources updated!`, 'success');
            }
        }

        // --- UI ---
        function initUI() {
            hide('loading-screen'); show('game-ui'); lucide.createIcons();
            document.getElementById('nav-nation-name').innerText = currentNation.name;
            document.getElementById('nav-flag').src = currentNation.flag;
            document.getElementById('dash-nation-name').innerText = currentNation.name;
            document.getElementById('dash-leader').innerText = currentNation.leader;
            document.getElementById('dash-pop').innerText = formatNum(currentNation.stats.population);
            renderResources();
            loadCities();
        }

        function renderResources() {
            const r = currentNation.resources;
            const m = currentNation.military;
            for(let k in r) document.getElementById(`res-${k}`).innerText = formatNum(r[k]);
            for(let k in m) document.getElementById(`mil-${k}`).innerText = formatNum(m[k]);
        }

        async function loadCities() {
            const list = document.getElementById('cities-list');
            const q = query(collection(db, "cities"), where("nationId", "==", currentUser.uid));
            const snaps = await getDocs(q);
            list.innerHTML = '';
            
            snaps.forEach(d => {
                const c = d.data();
                const cid = d.id;
                let btns = '';
                for(let t in BUILDING_STATS) {
                    btns += `<button onclick="window.build('${cid}','${t}')" class="bg-slate-800 p-2 rounded border border-slate-700 hover:border-blue-500 transition text-left">
                        <div class="text-[9px] text-slate-400 uppercase">${BUILDING_STATS[t].name}</div>
                        <div class="font-bold text-white">${c.buildings[t]||0}</div>
                    </button>`;
                }
                const el = document.createElement('div');
                el.className = 'game-card p-4 rounded-xl space-y-3';
                el.innerHTML = `<div class="font-bold text-white border-b border-slate-700 pb-2">${c.name}</div><div class="grid grid-cols-3 gap-2">${btns}</div>`;
                list.appendChild(el);
            });
        }

        window.build = async (cid, type) => {
            const cost = BUILDING_STATS[type].cost;
            if(currentNation.resources.money < cost) return toast(`Need $${formatNum(cost)}`, 'error');
            try {
                currentNation.resources.money -= cost; renderResources();
                await updateDoc(doc(db, "nations", currentUser.uid), { "resources.money": increment(-cost) });
                await updateDoc(doc(db, "cities", cid), { [`buildings.${type}`]: increment(1) });
                loadCities(); toast("Constructed!", 'success');
            } catch(e) { toast(e.message, 'error'); }
        };
        
        document.getElementById('found-city-btn').onclick = async () => {
             if(currentNation.resources.money < 50000) return toast("Need $50k", 'error');
             const name = prompt("City Name:"); if(!name) return;
             try {
                currentNation.resources.money -= 50000; renderResources();
                await updateDoc(doc(db, "nations", currentUser.uid), { "resources.money": increment(-50000) });
                await addDoc(collection(db, "cities"), { nationId: currentUser.uid, name, buildings: { house: 5, farm: 1, steelMill: 0, bauxiteMine: 0, refinery: 0, ammoFactory: 0 } });
                loadCities();
             } catch(e) { toast(e.message, 'error'); }
        };

        window.openRecruitModal = (type) => {
            selectedRecruitType = type;
            document.getElementById('recruit-type-name').innerText = type;
            document.getElementById('recruit-modal').classList.remove('hidden');
            let html = '';
            for(let k in UNIT_STATS[type].cost) html += `<div class="flex justify-between"><span>${k}:</span><span>${UNIT_STATS[type].cost[k]}</span></div>`;
            document.getElementById('recruit-cost-display').innerHTML = html;
        };

        document.getElementById('confirm-recruit-btn').onclick = async () => {
            const amt = parseInt(document.getElementById('recruit-amount').value);
            const unit = UNIT_STATS[selectedRecruitType];
            const updates = {};
            
            for(let r in unit.cost) {
                if(currentNation.resources[r] < unit.cost[r] * amt) return toast(`Missing ${r}`, 'error');
                updates[`resources.${r}`] = increment(-(unit.cost[r] * amt));
            }
            
            updates[`military.${selectedRecruitType}`] = increment(amt);
            await updateDoc(doc(db, "nations", currentUser.uid), updates);
            
            for(let r in unit.cost) currentNation.resources[r] -= (unit.cost[r] * amt);
            currentNation.military[selectedRecruitType] += amt;
            
            renderResources();
            document.getElementById('recruit-modal').classList.add('hidden');
            toast(`Recruited ${amt} units`, 'success');
        };

        window.switchView = async (v) => {
            ['dashboard','war','settings'].forEach(i=>hide('view-'+i)); show('view-'+v);
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.replace('text-blue-500','text-slate-500'));
            event.currentTarget.classList.replace('text-slate-500','text-blue-500');
            
            if(v === 'war') {
                const list = document.getElementById('enemy-list');
                const snaps = await getDocs(query(collection(db, "nations"), limit(10)));
                list.innerHTML = '';
                snaps.forEach(d => {
                    if(d.id === currentUser.uid) return;
                    const e = d.data();
                    const el = document.createElement('div');
                    el.className = 'bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center';
                    el.innerHTML = `<div class="flex items-center gap-3"><img src="${e.flag}" class="w-12 h-8 object-cover rounded shadow"><div><div class="font-bold text-white">${e.name}</div><div class="text-xs text-slate-400">${e.leader}</div></div></div><button onclick="window.attack('${d.id}')" class="bg-red-600 px-4 py-2 rounded font-bold text-xs text-white shadow-lg">ATTACK</button>`;
                    list.appendChild(el);
                });
            }
        };

        window.attack = async (tid) => {
            if(!confirm("Declare War?")) return;
            show('loading-screen');
            try {
                await runTransaction(db, async (t) => {
                    const me = (await t.get(doc(db,"nations",currentUser.uid))).data();
                    const en = (await t.get(doc(db,"nations",tid))).data();
                    const myS = (me.military.soldiers) + (me.military.tanks*10); // Simplified
                    const enS = (en.military.soldiers) + (en.military.tanks*10);
                    
                    if(myS * (0.9+Math.random()*0.2) > enS * (0.9+Math.random()*0.2)) {
                        const loot = Math.floor(en.resources.money * 0.15);
                        t.update(doc(db,"nations",currentUser.uid), { "resources.money": increment(loot), "military.soldiers": Math.floor(me.military.soldiers*0.95) });
                        t.update(doc(db,"nations",tid), { "resources.money": increment(-loot), "military.soldiers": Math.floor(en.military.soldiers*0.8) });
                        return {win:true, loot};
                    } else {
                        t.update(doc(db,"nations",currentUser.uid), { "military.soldiers": Math.floor(me.military.soldiers*0.85) });
                        return {win:false};
                    }
                }).then(res => {
                    hide('loading-screen');
                    toast(res.win ? `VICTORY! Looted $${formatNum(res.loot)}` : "DEFEAT", res.win?'success':'error');
                    loadGame();
                });
            } catch(e) { hide('loading-screen'); toast("Attack Failed", 'error'); }
        };
    </script>
</body>
</html>


